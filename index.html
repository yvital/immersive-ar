<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Immersive AR</title>

    <!-- three.js -->
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
</head>

<body>

    <!-- Starting an immersive WebXR session requires user interaction.
    We start this one with a simple button. -->
    <button onclick="activateXR()">Start immersive AR</button>
    <script>
        async function activateXR() {
            // Add a canvas element and initialize a WebGL context that is compatible with WebXR.
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const gl = canvas.getContext("webgl", { xrCompatible: true });

            let floorInRoom = 0;

            // To be continued in upcoming steps.
            const scene = new THREE.Scene();

            let geometryRabbit = new THREE.PlaneGeometry(720 / 500, 1280 / 500);
            let textureRabbit_0 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d0.png');
            let materialRabbit_0 = new THREE.MeshBasicMaterial({ map: textureRabbit_0, transparent: true });
            let textureRabbit_1 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d1.png');
            let materialRabbit_1 = new THREE.MeshBasicMaterial({ map: textureRabbit_1, transparent: true });
            let textureRabbit_2 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d2.png');
            let materialRabbit_2 = new THREE.MeshBasicMaterial({ map: textureRabbit_2, transparent: true })
            let textureRabbit_3 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d3.png');
            let materialRabbit_3 = new THREE.MeshBasicMaterial({ map: textureRabbit_3, transparent: true })
            let textureRabbit_4 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d4.png');
            let materialRabbit_4 = new THREE.MeshBasicMaterial({ map: textureRabbit_4, transparent: true })
            let textureRabbit_5 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d5.png');
            let materialRabbit_5 = new THREE.MeshBasicMaterial({ map: textureRabbit_5, transparent: true })
            let textureRabbit_6 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d6.png');
            let materialRabbit_6 = new THREE.MeshBasicMaterial({ map: textureRabbit_6, transparent: true })
            let textureRabbit_7 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d7.png');
            let materialRabbit_7 = new THREE.MeshBasicMaterial({ map: textureRabbit_7, transparent: true })
            let textureRabbit_8 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d8.png');
            let materialRabbit_8 = new THREE.MeshBasicMaterial({ map: textureRabbit_8, transparent: true })
            let textureRabbit_9 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d9.png');
            let materialRabbit_9 = new THREE.MeshBasicMaterial({ map: textureRabbit_9, transparent: true })
            let textureRabbit_10 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d10.png');
            let materialRabbit_10 = new THREE.MeshBasicMaterial({ map: textureRabbit_10, transparent: true })
            let textureRabbit_11 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d11.png');
            let materialRabbit_11 = new THREE.MeshBasicMaterial({ map: textureRabbit_11, transparent: true })
            let textureRabbit_12 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d12.png');
            let materialRabbit_12 = new THREE.MeshBasicMaterial({ map: textureRabbit_12, transparent: true })
            let textureRabbit_13 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d13.png');
            let materialRabbit_13 = new THREE.MeshBasicMaterial({ map: textureRabbit_13, transparent: true })
            let textureRabbit_14 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d14.png');
            let materialRabbit_14 = new THREE.MeshBasicMaterial({ map: textureRabbit_14, transparent: true })
            let textureRabbit_15 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d15.png');
            let materialRabbit_15 = new THREE.MeshBasicMaterial({ map: textureRabbit_15, transparent: true })
            let textureRabbit_16 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d16.png');
            let materialRabbit_16 = new THREE.MeshBasicMaterial({ map: textureRabbit_16, transparent: true })
            let textureRabbit_17 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d17.png');
            let materialRabbit_17 = new THREE.MeshBasicMaterial({ map: textureRabbit_17, transparent: true })
            let textureRabbit_18 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d18.png');
            let materialRabbit_18 = new THREE.MeshBasicMaterial({ map: textureRabbit_18, transparent: true })
            let textureRabbit_19 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d19.png');
            let materialRabbit_19 = new THREE.MeshBasicMaterial({ map: textureRabbit_19, transparent: true })
            let textureRabbit_20 = new THREE.TextureLoader().load('https://raw.githubusercontent.com/yvital/immersive-ar/development/rabbit/d20.png');
            let materialRabbit_20 = new THREE.MeshBasicMaterial({ map: textureRabbit_20, transparent: true })
            let rabbitOne = new THREE.Mesh(geometryRabbit, materialRabbit_0);

            function videoFrame() {
                let index = 0;
                function changeImage() {
                    if (index == 0) {
                        rabbitOne.material = materialRabbit_0;
                    }
                    if (index == 1) {
                        rabbitOne.material = materialRabbit_1;
                    }
                    if (index == 2) {
                        rabbitOne.material = materialRabbit_2;
                    }
                    if (index == 3) {
                        rabbitOne.material = materialRabbit_3;
                    }
                    if (index == 4) {
                        rabbitOne.material = materialRabbit_4;
                    }
                    if (index == 5) {
                        rabbitOne.material = materialRabbit_5;
                    }
                    if (index == 6) {
                        rabbitOne.material = materialRabbit_6;
                    }
                    if (index == 7) {
                        rabbitOne.material = materialRabbit_7;
                    }
                    if (index == 8) {
                        rabbitOne.material = materialRabbit_8;
                    }
                    if (index == 9) {
                        rabbitOne.material = materialRabbit_9;
                    }
                    if (index == 10) {
                        rabbitOne.material = materialRabbit_10;
                    }
                    if (index == 11) {
                        rabbitOne.material = materialRabbit_11;
                    }
                    if (index == 12) {
                        rabbitOne.material = materialRabbit_12;
                    }
                    if (index == 13) {
                        rabbitOne.material = materialRabbit_13;
                    }
                    if (index == 14) {
                        rabbitOne.material = materialRabbit_14;
                    }
                    if (index == 15) {
                        rabbitOne.material = materialRabbit_15;
                    }
                    if (index == 16) {
                        rabbitOne.material = materialRabbit_16;
                    }
                    if (index == 17) {
                        rabbitOne.material = materialRabbit_17;
                    }
                    if (index == 18) {
                        rabbitOne.material = materialRabbit_18;
                    }
                    if (index == 19) {
                        rabbitOne.material = materialRabbit_19;
                    }
                    if (index == 20) {
                        rabbitOne.material = materialRabbit_20;
                    }
                    index++;
                    if (index > 20) index = 0;

                }
                setInterval(() => changeImage(), 140);
            }        
            
            videoFrame();

            // Set up the WebGLRenderer, which handles rendering to the session's base layer.
            const renderer = new THREE.WebGLRenderer({
                alpha: true,
                preserveDrawingBuffer: true,
                canvas: canvas,
                context: gl
            });
            renderer.autoClear = false;

            // The API directly updates the camera matrices.
            // Disable matrix auto updates so three.js doesn't attempt
            // to handle the matrices independently.
            const camera = new THREE.PerspectiveCamera();
            camera.matrixAutoUpdate = false;

            // Initialize a WebXR session using "immersive-ar".
            const session = await navigator.xr.requestSession("immersive-ar", { requiredFeatures: ['hit-test'] });
            session.updateRenderState({
                baseLayer: new XRWebGLLayer(session, gl)
            });

            // A 'local' reference space has a native origin that is located
            // near the viewer's position at the time the session was created.
            const referenceSpace = await session.requestReferenceSpace('local');

            // Create another XRReferenceSpace that has the viewer as the origin.
            const viewerSpace = await session.requestReferenceSpace('viewer');
            // Perform hit testing using the viewer as origin.
            const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

            const loader = new THREE.GLTFLoader();
            let reticle;
            loader.load("https://immersive-web.github.io/webxr-samples/media/gltf/reticle/reticle.gltf", function (gltf) {
                reticle = gltf.scene;
                reticle.visible = false;
                scene.add(reticle);
            })


            session.addEventListener("select", (event) => {
                /* if (flower) {
                    const clone = flower.clone();
                    clone.position.copy(reticle.position);
                    scene.add(clone);
                } */

                //rabbitOne.position.copy(reticle.position);
                //rabbitOne.rotateX(Math.PI);

                rabbitOne.position.x = 0;
                rabbitOne.position.y = reticle.position.y;
                rabbitOne.position.z = reticle.position.z;

                scene.add(rabbitOne);
            });



            // Create a render loop that allows us to draw on the AR view.
            const onXRFrame = (time, frame) => {
                // Queue up the next draw request.
                session.requestAnimationFrame(onXRFrame);

                // Bind the graphics framebuffer to the baseLayer's framebuffer
                gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer)

                // Retrieve the pose of the device.
                // XRFrame.getViewerPose can return null while the session attempts to establish tracking.
                const pose = frame.getViewerPose(referenceSpace);
                if (pose) {
                    // In mobile AR, we only have one view.
                    const view = pose.views[0];

                    const viewport = session.renderState.baseLayer.getViewport(view);
                    renderer.setSize(viewport.width, viewport.height)

                    // Use the view's transform matrix and projection matrix to configure the THREE.camera.
                    camera.matrix.fromArray(view.transform.matrix)
                    camera.projectionMatrix.fromArray(view.projectionMatrix);
                    camera.updateMatrixWorld(true);

                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0 && reticle) {
                        const hitPose = hitTestResults[0].getPose(referenceSpace);
                        reticle.visible = true;
                        floorInRoom = Math.min(floorInRoom, hitPose.transform.position.y);
                        reticle.position.set(hitPose.transform.position.x, floorInRoom, hitPose.transform.position.z)
                        reticle.updateMatrixWorld(true);
                    }

                    // Render the scene with THREE.WebGLRenderer                    
                    renderer.render(scene, camera)
                }
            }
            session.requestAnimationFrame(onXRFrame);
        }
    </script>
</body>

</html>